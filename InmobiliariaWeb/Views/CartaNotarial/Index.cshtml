@model Domain.CartaNotarial.CartaNotarialViewDTO
@{
}
<form method="post" asp-controller="CartaNotarial" asp-action="Index">
    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="row row-cols-2">
                    <div class="col-9">
                        <h2>Carta Notarial</h2>
                    </div>
                    <div class="col-3 text-end">
                        <a class="btn btn-outline-success" asp-controller="CartaNotarial" asp-action="CartaNotarial1Crear">
                            Nuevo
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-12 col-sm-12 col-md-6 col-lg-8">
                        <div class="form-floating">
                            <select class="form-select" id="lProgramas" asp-for="@Model.nIdent_Programa">
                                <option value="0"></option>
                                @foreach (var programas in Model.lProgramas)
                                {
                                    <option value="@programas.nIdent_Programa">@programas.sNombrePrograma</option>
                                }
                            </select>
                            <label for="lProgramas">Seleccione Programa</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-3 col-lg-2">
                        <div class="form-floating">
                            <select class="form-select" id="lManzanas" asp-for="@Model.nIdent_Manzana">
                                <option value="0"></option>
                            </select>
                            <label for="lManzanas">Mz</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-3 col-lg-2">
                        <div class="form-floating">
                            <select class="form-select" id="lLotes" asp-for="@Model.nIdent_Lote">
                                <option value="0"></option>
                            </select>
                            <label for="lLotes">Lt</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-floating">
                            <input class="form-control" type="text" id="cliente" placeholder="" asp-for="@Model.sBuscar" />
                            <label for="cliente">Cliente:</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-outline-info">
                    Filtrar
                </button>
            </div>
        </div>
        <div class="table-responsive-md mt-1">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Carta Notarial</th>
                        <th>Programa</th>
                        <th>Mz</th>
                        <th>Lt</th>
                        <th>Contrato</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cartasNotariales in Model.lCartaNotarialList)
                    {
                        var collapseId = $"detalle_{cartasNotariales.nIdent_CartaNotarial}";
                        var collapseSelector = $"detalle-{cartasNotariales.nIdent_CartaNotarial}";
                        <tr ondblclick="toggleDetalle('@collapseSelector'); cargarDetalle(@cartasNotariales.nIdent_CartaNotarial)"
                            style="cursor:pointer;">
                            <td>@cartasNotariales.sNumeroCartaNotarial</td>
                            <td>@cartasNotariales.sNombrePrograma</td>
                            <td>@cartasNotariales.sManzana</td>
                            <td>@cartasNotariales.sLote</td>
                            <td>@cartasNotariales.sNumeroContrato</td>
                            <td>@cartasNotariales.sNombreCliente</td>
                            <td>@(cartasNotariales.dFechaCartaNotarial?.ToString("dd/MM/yyyy") ?? "")</td>
                            <td>
                                <a class="btn btn-outline-secondary"
                                    asp-controller="CartaNotarial"
                                    asp-action="@(cartasNotariales.nIdent_027_TipoCartaNotarial == 1159 ? "CartaNotarial1Ver" : "CartaNotarial2Ver")"
                                    asp-route-nIdent_CartaNotarial="@cartasNotariales.nIdent_CartaNotarial">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                            <td>
                                @if (cartasNotariales.nIdent_027_TipoCartaNotarial == 1159
                                                            && (cartasNotariales.nIdent_026_EstadoCartaNotarial == 1155
                                                            || cartasNotariales.nIdent_026_EstadoCartaNotarial == 1158))
                                {
                                    <a class="btn btn-outline-primary">
                                        <i class="bi bi-file-text"></i>
                                    </a>
                                }
                                else
                                {
                                    <a class="btn btn-outline-secondary disabled">
                                        <i class="bi bi-file-text"></i>
                                    </a>
                                }
                            </td>
                        </tr>
                        <!-- FILA DE DETALLE -->
                        <tr class="collapse" id="@collapseSelector">
                            <td colspan="8">
                                <div class="p-3 border rounded bg-light">
                                    <strong>Detalles de esta carta notarial</strong>
                                    <div id="contenedor-detalle-@cartasNotariales.nIdent_CartaNotarial">
                                        Cargando...
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // 🔹 Cuando cambie el select de programa
        const programaSelect = document.getElementById("lProgramas");
        programaSelect.addEventListener("change", function () {
            const programaId = this.value;

            if (programaId && programaId !== "0") {
                ObtenerManzanas(programaId, '');
            } else {
                $("#lManzanas").empty().append('<option value="0"></option>');
                $("#lLotes").empty().append('<option value="0"></option>');
            }
        });

        // 🔹 Cuando cambie el select de manzana
        const manzanaSelect = document.getElementById("lManzanas");
        manzanaSelect.addEventListener("change", function () {
            const manzanaId = this.value;

            if (manzanaId && manzanaId !== "0") {
                ObtenerLotes(manzanaId, '');
            } else {
                $("#lLotes").empty().append('<option value="0"></option>');
            }
        });
    }); 

    function ObtenerManzanas(programaId, defaults) {
        $.get(`/CartaNotarial/ManzanasConCartaNotarial?programaId=${programaId}`, function (data) {
            $("#lManzanas").empty();
            $("#lManzanas").append('<option value=""></option>');
            $.each(data, function (index, item) {
                $("#lManzanas").append('<option value="' + item.nIdent_Manzana + '">' + item.sManzana + '</option>');
            });
            $("#lManzanas").val(defaults);
        });
    }

    function ObtenerLotes(manzanaId, defaults) {
        $.get(`/CartaNotarial/LoteConCartaNotarial?manzanaId=${manzanaId}`, function (data) {
            $("#lLotes").empty();
            $("#lLotes").append('<option value=""></option>');
            $.each(data, function (index, item) {
                $("#lLotes").append('<option value="' + item.nIdent_Lote + '">' + item.sLote + '</option>');
            });
            $("#lLotes").val(defaults);
        });
    }
        function toggleDetalle(id) {

        // 1. Cerrar otros collapse distintos al que se está abriendo
        document.querySelectorAll("tr.collapse.show").forEach(function (row) {
            if (row.id !== id) {
                bootstrap.Collapse.getOrCreateInstance(row).hide();
            }
        });

        // 2. Abrir/cerrar el seleccionado
        const target = document.getElementById(id);
        const bs = bootstrap.Collapse.getOrCreateInstance(target);

        if (target.classList.contains("show")) {
            bs.hide(); // Si está abierto → cerrar
        } else {
            bs.show(); // Si está cerrado → abrir
        }
    }
    function cargarDetalle(id) {
        $.ajax({
            url: '/CartaNotarial/GetCartaNotarialDetalle',
            type: 'GET',
            data: { nIdent_CartaNotarial: id },
            success: function (data) {

                let html = `
                    <table class="table table-sm table-bordered mt-2">
                        <thead class="table-secondary">
                            <tr>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Observacion</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (data.length === 0) {
                    html += `<tr><td colspan="4" class="text-center">No hay detalles disponibles</td></tr>`;
                } else {
                    data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.sEstadoDescripcion ?? ""}</td>
                                <td>${item.dFechaCreacion ? formatDate(item.dFechaCreacion) : ""}</td>
                                <td>${item.sObservacion ?? ""}</td>
                            </tr>`;
                    });
                }

                html += `</tbody></table>`;

                $("#contenedor-detalle-" + id).html(html);
            },
            error: function () {
                $("#contenedor-detalle-" + id)
                    .html("<div class='text-danger'>Error al cargar detalle.</div>");
            }
        });
    }

    // Función para formatear fechas (yyyy-MM-dd → dd/MM/yyyy)
    function formatDate(dateStr) {
        const fecha = new Date(dateStr);
        return fecha.toLocaleDateString('es-PE');
    }
</script>