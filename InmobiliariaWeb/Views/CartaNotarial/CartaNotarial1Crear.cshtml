@model Domain.CartaNotarial.CartaNotarial1ViewDTO
@{
}
<form asp-action="CartaNotarial1Crear" method="post">
    <input type="hidden" id="nIdent_Contratos" asp-for="@Model.nIdent_Contratos" />
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Nueva Carta Notarial 15 dias</h2>
            </div>
            <div class="card-body">
                <div class="row g-1">
                    <div class="col-12 col-sm-12 col-md-8 col-lg-8 col-xl-10">
                        <div class="form-floating">
                            <select class="form-select" id="lProgramas" asp-for="@Model.nIdent_Programa" required>
                                <option value="0"></option>
                                @foreach (var programas in Model.lPrograma)
                                {
                                    <option value="@programas.nIdent_Programa">@programas.sNombrePrograma</option>
                                }
                            </select>
                            <label>Seleccione Programa</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-2 col-lg-2 col-xl-1">
                        <div class="form-floating">
                            <select class="form-select" id="lManzanas" asp-for="@Model.nIdent_Manzana">
                                <option value="0"></option>
                            </select>
                            <label for="lManzanas">Mz</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-2 col-lg-2 col-xl-1">
                        <div class="form-floating">
                            <select class="form-select" id="lLotes" asp-for="@Model.nIdent_Lote">
                                <option value="0"></option>
                            </select>
                            <label for="lLotes">Lt</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="sNumeroContrato" asp-for="@Model.sNumeroContrato" readonly />
                            <label>Numero Contrato</label>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="nCuotasPendientes" asp-for="@Model.nCuotasPendientes" readonly />
                            <label>Cuotas Pendientes</label>
                        </div>
                    </div>
                </div>
                <div class="group-box mt-3">
                    <span class="group-box-title">Clientes</span>
                    <div class="group-box-content">
                        <table class="table table-hover align-middle mb-0" id="clientesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>Apellidos y Nombres</th>
                                    <th>Documento</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">Seleccione un lote</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row g-1 mt-1">
                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                        <div class="form-floating">
                            <input type="date" class="form-control" asp-for="dFechaCartaNotarial"/>
                            <label>Fecha Carta Notarial</label>
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-outline-primary" type="submit">Registrar</button>
                </div>
            </div>
        </div>
    </div>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
    $(document).ready(function () {
        let programaDefault = '@Model.nIdent_Programa';
        let manzanaDefault = '@Model.nIdent_Manzana';
        let loteDefault = '@Model.nIdent_Lote';

        if (programaDefault) {
            ObtenerManzanas(programaDefault, manzanaDefault);
            if (manzanaDefault) {
                ObtenerLotes(manzanaDefault, loteDefault);
            }
        }
        // 🔹 Cuando cambie el select de programa
        const programaSelect = document.getElementById("lProgramas");
        programaSelect.addEventListener("change", function () {
            const programaId = this.value;

            if (programaId && programaId !== "0") {
                ObtenerManzanas(programaId, '');
            } else {
                $("#lManzanas").empty().append('<option value="0"></option>');
                $("#lLotes").empty().append('<option value="0"></option>');
            }
        });

        // 🔹 Cuando cambie el select de manzana
        const manzanaSelect = document.getElementById("lManzanas");
        manzanaSelect.addEventListener("change", function () {
            const manzanaId = this.value;

            if (manzanaId && manzanaId !== "0") {
                ObtenerLotes(manzanaId, '');
            } else {
                $("#lLotes").empty().append('<option value="0"></option>');
            }
        });
        // 🔹 Cuando cambie el select de lote
        const loteSelect = document.getElementById("lLotes");
        loteSelect.addEventListener("change",function(){
            const loteId = this.value;

            if (loteId && loteId !== "0"){
                ObtenerContratoPorLote(loteId);
            }
        });

    });
    function ObtenerManzanas(programaId, defaults) {
        $.get(`/CartaNotarial/ManzanasConContrato?programaId=${programaId}`, function (data) {
            $("#lManzanas").empty();
            $("#lManzanas").append('<option value=""></option>');
            $.each(data, function (index, item) {
                $("#lManzanas").append('<option value="' + item.nIdent_Manzana + '">' + item.sManzana + '</option>');
            });
            $("#lManzanas").val(defaults);

            // Limpieza adicional por seguridad:
            $("#lote").empty().append('<option value=""></option>');
            $("#nIdent_Contratos").val('');
            $("#sNumeroContrato").val('');
            $("#nCuotasPendientes").val('');
            $("#clientesTable tbody").empty();
        });
    }

        function ObtenerLotes(manzanaId, defaults) {
        $.get(`/CartaNotarial/LoteConContrato?manzanaId=${manzanaId}`, function (data) {
            $("#lLotes").empty();
            $("#lLotes").append('<option value=""></option>');
            $.each(data, function (index, item) {
                $("#lLotes").append('<option value="' + item.nIdent_Lote + '">' + item.sLote + '</option>');
            });
            $("#lLotes").val(defaults);

            $("#nIdent_Contratos").val('');
            $("#sNumeroContrato").val('');
            $("#nCuotasPendientes").val('');
            $("#clientesTable tbody").empty();
        });
    }
    function ObtenerContratoPorLote(loteId) {
        if (!loteId) {
            // Si no hay lote seleccionado, limpiamos los campos
            $("#nIdent_Contratos").val('');
            $("#sNumeroContrato").val('');
            $("#clientesTable tbody").empty();
            return;
        }

        $.get(`/CartaNotarial/GetContratoPorLote?loteId=${loteId}`, function (data) {
            if (data) {
                // 1️⃣ Llenar los datos del contrato
                $("#nIdent_Contratos").val(data.nIdent_Contratos);
                $("#sNumeroContrato").val(data.sNumeroContrato);
                $("#nCuotasPendientes").val(data.nCuotasPendientes);

                // 2️⃣ Luego llamar a los clientes del contrato
                $.get(`/CartaNotarial/GetClientesPorContrato?contratoId=${data.nIdent_Contratos}`, function (clientes) {
                    const tbody = $("#clientesTable tbody");
                    tbody.empty();

                    if (clientes.length === 0) {
                        tbody.append('<tr><td colspan="3" class="text-center">No hay clientes asociados</td></tr>');
                    } else {
                        $.each(clientes, function (i, cliente) {
                                tbody.append(`
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   class="form-check-input cliente-check"
                                                   name="PersonasSeleccionadas"
                                                   value="${cliente.nIdent_Persona}" />
                                        </td>
                                        <td>${cliente.sNombreCompleto}</td>
                                        <td>${cliente.sNumeroDocumento ?? ''}</td>
                                    </tr>
                                `);
                        });
                    }
                });
            } else {
                // Si no hay contrato, limpiar todo
                $("#nIdent_Contratos").val('');
                $("#sNumeroContrato").val('');
                $("#nCuotasPendientes").val('');
                $("#clientesTable tbody").empty();
            }
        }).fail(function () {
            $("#nIdent_Contratos").val('');
            $("#sNumeroContrato").val('');
            $("#nCuotasPendientes").val('');
            $("#clientesTable tbody").empty();
        });
    }
</script>
